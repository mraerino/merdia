<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title></title>
  <meta name="description" content="" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <button id="start">Start!</button>
  <script type="module">
    import { JSONParser } from "https://unpkg.com/@streamparser/json@0.0.13/dist/mjs/index.js";

    async function* parseJsonObjectStream(stream, handler) {
      const parser = new JSONParser({ paths: ["$"], separator: "" });

      const reader = stream.getReader();
      let nextData;
      while (true) {
        const nextValue = new Promise((resolve) => {
          parser.onValue = resolve
        });

        if (nextData) {
          const { done, value } = nextData;
          if (value) {
            try {
              parser.write(value);
            } catch (e) {
              console.error("failed to parse json", e);
              return;
            }
          }
          if (done) {
            yield (await nextValue).value;
            return
          }
        }

        const reading = reader.read();
        const output = await Promise.race([nextValue, reading])
        if ("done" in output) {
          nextData = output;
        } else {
          yield output.value;
          // ensure we process the requested data if the `nextValue` promise won
          nextData = await reading;
        }
      }
    }

    const displayMediaOptions = {
      video: {
        cursor: "always",
      },
      audio: false
    };

    const connectWebRTC = async () => {
      const peerConn = new RTCPeerConnection({
        iceServers: [],
      });
      peerConn.addEventListener("iceconnectionstatechange", () =>
        console.debug("connection state change:", peerConn.iceConnectionState)
      );
      const gatherPromise = new Promise((resolve) => {
        peerConn.addEventListener("icecandidate", ({ candidate }) => {
          if (candidate === null) {
            resolve()
          }
        })
      })

      const stream = await navigator.mediaDevices.getDisplayMedia(displayMediaOptions);
      stream.getTracks().forEach(track => peerConn.addTrack(track, stream));

      const initialOffer = await peerConn.createOffer();
      await peerConn.setLocalDescription(initialOffer);

      await gatherPromise;

      const resp = await fetch("/screen_share", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ offer: peerConn.localDescription.sdp })
      });

      if (!resp.ok) {
        throw new Error(`Invalid response: ${resp.status}, ${await resp.text()}`)
      }

      const signalingStream = parseJsonObjectStream(resp.body);
      const { done, value } = await signalingStream.next();
      if (value.answer) {
        console.log("setting remote description", value.answer)
        await peerConn.setRemoteDescription(value.answer)
      } else {
        console.log("invalid json item when expecting SDP answer", value)
      }

      if (!done) {
        // add ice candidates in the background
        (async () => {
          for await (const value of signalingStream) {
            if (value.candidate) {
              console.log("adding candidate", value.candidate)
              await peerConn.addIceCandidate(value.candidate)
            } else {
              console.log("invalid json item", value)
            }
          }
        })()
      }

      return peerConn;
    }

    document.getElementById("start").addEventListener("click", () => {
      connectWebRTC()
    })
  </script>
</body>

</html>